on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    uses: ./.github/workflows/build.yml

  deploy:
    name: Prepare release
    runs-on: ubuntu-latest
    needs:
      - build
    steps:
      - name: Get vendor files
        uses: actions/download-artifact@v3
        with:
          name: vendor-prod

      - name: Debug
        run: |
          ls -la
          ls -la collectme
          ls -la dist
          ls -la collectme/dist

      - name: Get dist files
        uses: actions/download-artifact@v3
        with:
          name: dist-prod

      - name: Get pot files
        uses: actions/download-artifact@v3
        with:
          name: pot
          path: languages/collectme.pot

      - name: Package files
        run: |
          mkdir /tmp/collectme
          rsync -av --exclude=index.html --exclude=favicon.ico ./dist /tmp/collectme
          rsync -av ./languages /tmp/collectme
          rsync -av ./src /tmp/collectme
          mkdir /tmp/collectme/tmp
          rsync -av ./vendor /tmp/collectme
          rsync -av ./views /tmp/collectme
          cp ./collectme.php /tmp/collectme
          cp ./dependency-config.php /tmp/collectme
          echo "See ${{ github.server_url }}/${{ github.repository }}" > /tmp/collectme/readme.txt
          cd /tmp
          zip -r collectme.zip collectme

      - name: Parse version number
        run: |
          echo "VERSION=$(sed '/^\s*\*\s*Version:/! d; s/^\s*\*\s*Version:\s*//; s/\s*$//' collectme.php)" >> $GITHUB_ENV

      - name: Prepare release
        uses: softprops/action-gh-release@v1
        with:
          files: /tmp/collectme.zip
          draft: true
          generate_release_notes: true
          name: "${{ env.VERSION }}"